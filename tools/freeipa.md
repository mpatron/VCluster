#!/bin/bash

export IPA_SERVER_PASSWORD=Welcome1!
export IPA_SERVER_NAME=iam
export IPA_SERVER_DOMAIN=jobjects.org
export IPA_SERVER_IP=192.168.122.100

sudo hostnamectl set-hostname $IPA_SERVER_NAME.$IPA_SERVER_DOMAIN

sudo yum -y update
sudo yum -y install ipa-server ipa-server-dns bind bind-dyndb-ldap vim lsof lynx nmap firewalld bind-utils

sudo ipa-server-install --admin-password=$IPA_SERVER_PASSWORD --ds-password=$IPA_SERVER_PASSWORD  --hostname=$IPA_SERVER_NAME.$IPA_SERVER_DOMAIN --ip-address=$IPA_SERVER_IP --domain=$IPA_SERVER_DOMAIN --realm=${IPA_SERVER_DOMAIN^^} --mkhomedir --setup-dns --forwarder=8.8.8.8 --forwarder=8.8.4.4 --auto-reverse --ssh-trust-dns --unattended

printf "$IPA_SERVER_PASSWORD\n" | kinit admin
klist
ipa config-mod --defaultshell=/bin/bash
ipa user-find admin
dig @$IPA_SERVER_NAME.$IPA_SERVER_DOMAIN +short $IPA_SERVER_NAME.$IPA_SERVER_DOMAIN A


sudo firewall-cmd --permanent --add-service={ntp,http,https,ldap,ldaps,kerberos,kpasswd,dns}
sudo firewall-cmd --complete-reload

ipa user-add alice --first="Alice" --last="Savoie"  --email="alice@jobjects.org" --random > ~/user-alice.txt && cat ~/user-alice.txt
ipa user-add bob --first="Bob" --last="Marley"  --email="bob@jobjects.org" --random > ~/user-bob.txt && cat ~/user-bob.txt
ipa user-add carole --first="Carole" --last="Rousseau"  --email="carole@jobjects.org" --random > ~/user-carole.txt && cat ~/user-carole.txt
ipa user-add dave --first="Dave" --last="Levenbach"  --email="dave@jobjects.org" --random > ~/user-dave.txt && cat ~/user-dave.txt
ipa user-add eve --first="Eve" --last="Angeli"  --email="eve@jobjects.org" --random > ~/user-eve.txt && cat ~/user-eve.txt
ipa user-add franck --first="Frank" --last="Dubosc"  --email="franck@jobjects.org" --random > ~/user-franck.txt && cat ~/user-franck.txt

[root@freeipa ~]# cat /etc/resolv.conf
# Generated by NetworkManager
search jobjects.org
nameserver 192.168.56.110
nameserver 192.168.0.254

ipa dnsrecord-add 56.168.192.in-addr.arpa. 111 --ptr-rec=gitlab.jobjects.org.
ipa dnsrecord-add 56.168.192.in-addr.arpa. 112 --ptr-rec=mail.jobjects.org.
ipa dnsrecord-add 56.168.192.in-addr.arpa. 113 --ptr-rec=gui.jobjects.org.
ipa dnsrecord-add 56.168.192.in-addr.arpa. 114 --ptr-rec=keycloak.jobjects.org.
ipa dnsrecord-add 56.168.192.in-addr.arpa. 115 --ptr-rec=wildfly.jobjects.org.
ipa dnsrecord-add 56.168.192.in-addr.arpa. 116 --ptr-rec=docker.jobjects.org.

Lien du ca.crt de Freeipa :
http://freeipa.jobjects.org/ipa/config/ca.crt

http://directory.apache.org/studio/downloads.html
ldaps://iam.jobjects.org:636
user     : uid=admin,cn=users,cn=accounts,dc=jobjects,dc=org
password : $IPA_SERVER_PASSWORD
DN: cn=admins,cn=groups,cn=accounts,dc=jobjects,dc=org


ipa service-add monservice/mamachine.jobjects.org
ipa-getcert request -r -f /etc/ssl/certs/monservice.crt -k /etc/ssl/certs/monservice.key -K monservice/mamachine.jobjects.org

sudo ipa-getcert list


## Hashicopr Vault
https://medium.com/@mitesh_shamra/setup-hashicorp-vault-using-ansible-fa8073a70a56
https://github.com/MiteshSharma/AnsibleVaultRole

 